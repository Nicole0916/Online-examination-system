<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>智慧监控大屏</title>
    <link rel="stylesheet" href="../static/css/vid/bootstrap.min.css">
    <link rel="stylesheet" href="../static/css/vid/base.css">
    <link rel="stylesheet" href="../static/css/vid/vid_index.css">
    <link rel="stylesheet" href="../static/css/index.css"/>
</head>
<style>


        .button_press {
  display: inline-block;
  padding: 15px 25px;
  font-size: 15px;
  cursor: pointer;
  text-align: center;
  text-decoration: none;
  outline: none;
  color: #fff;
  background-color: #4CAF50;
  border: none;
  border-radius: 15px;
  box-shadow: 0 9px #999;
}

    .button_press:hover {background-color: #3e8e41}

.button_press:active {
  background-color: #3e8e41;
  box-shadow: 0 5px #666;
  transform: translateY(4px);
}


.main_canvas{

    border: 1px solid rgb(1,116,183);
    width: 100%;
    position: relative;
    height: 138%;
    margin: -3px;
    box-shadow: inset 0px 0px 50px #094494;
    box-sizing: border-box;
    border-width: 47px 37px 43px 24px;
    border-image: url(../static/img/border.png) 50 37 20 132;
}

.main_canvas_name{
    color: red;
    position: fixed;
    left: 29%;
    top: 41%;
    font-size: 26px;
}

</style>
<body>

 
<main class="main">
    <!--头部-->
    <div class="header">
    <div>
        智慧监控大屏
    </div>
    <div style="font-size: 15px">
        Intelligent monitoring screen
    </div>
    <a href="javascript:;" class="a-access">
{#        <button class="button type1" onclick="window.location.replace('/train')">#}
        <button class="button type1">
    		Admin
    	</button>
    </a>
</div>

{#    <!--头部-->#}
{#    <header class="heared">#}
{#        <span class="head-logo">前后台通用模板</span>#}
{#        <ul class="head-ul"><li><a href="index.html" class="active-a">首页</a> </li>#}
{#            <li><a href="videlctr.html">视频监控</a> </li>#}
{#            <li><a href="map.html">地图管理</a> </li>#}
{#            <li><a href="static.html">统计分析</a> </li>#}
{#            <li><a href="form.html">表单信息</a> </li>#}
{#            <li><a href="user.html">用户管理</a></li>#}
{#            <li><a href="part.html">部门管理</a></li>#}
{#            <li><a href="date.html">日程管理</a></li>#}
{##}
{#        </ul>#}
{#        <div class="head-right"><span id="time"></span><span>Admin</span></div>#}
{#    </header>#}
    <!--身体-->
    <section class="section commanBox">
        <!--左侧区域-->
        <div class="boxLeft">
            <!--视频监控-->


            <div class="boxLeftVideoTop"></div>
            <div class="clear"></div>


            <div class="boxLeftVideoBox">
                <ul>
                    <li>
                        <div class="BoxConTop"><span class="BoxconTopLeft" id="name1">马耀飞（12021219103）</span><span class="BoxconTopRight"><img src="../static/img/ico.png"/> </span></div>
                        <div class="boxLeftVideoBoxCon">
                            <img id="img1" src="../static/ynu.png" width="100%" height="208px" onclick="click_video(this)">
                        </div>
                        <div class="clear"></div>
                    </li>
                    <li>
                        <div class="BoxConTop"><span class="BoxconTopLeft" id="name2">李小鹏（12021219104）</span><span class="BoxconTopRight"><img src="../static/img/ico.png"/> </span></div>
                        <div class="boxLeftVideoBoxCon">
                            <img id="img2" src="../static/ynu.png" width="100%" height="208px" onclick="click_video(this)">
                        </div>
                        <div class="clear"></div>
                    </li>
                    <li>
                        <div class="BoxConTop"><span class="BoxconTopLeft" id="name3">张强荐（12020219112）</span><span class="BoxconTopRight"><img src="../static/img/ico.png"/> </span></div>
                        <div class="boxLeftVideoBoxCon">
                            <img id="img3" src="../static/ynu.png" width="100%" height="208px" onclick="click_video(this)">
                        </div>
                        <div class="clear"></div>
                    </li>
                    <li>
                        <div class="BoxConTop"><span class="BoxconTopLeft" id="name4">李平周（12021219103）</span><span class="BoxconTopRight"><img src="../static/img/ico.png"/> </span></div>
                        <div class="boxLeftVideoBoxCon">
                             <img id="img4" src="../static/ynu.png" width="100%" height="208px" onclick="click_video(this)">
                        </div>
                        <div class="clear"></div>
                    </li>
                    <li>
                        <div class="BoxConTop"><span class="BoxconTopLeft" id="name5">刘前（12021219103）</span><span class="BoxconTopRight"><img src="../static/img/ico.png"/> </span></div>
                        <div class="boxLeftVideoBoxCon">
                            <img id="img5" src="../static/ynu.png" width="100%" height="208px" onclick="click_video(this)">
                        </div>
                        <div class="clear"></div>
                    </li>


                </ul>

            </div>
            <div class="clear"></div>



            <!--报警信息-->
            <div class="boxLeftAram" >
                <div class="boxLeftAlamTop"></div>
                <div class="boxLeftAlamCon">
                    <ul class="alamUl" id="log_all">


                    </ul>
                </div>
            </div>
        </div>
        <!--中间区域-->
        <div class="boxCenter">
            <!--案件分析-->
            <div class="boxCenterUp">
                <div class="boxCentterUpLeft">
                    <div class="ananBg"><img src="../static/img/ana01.png" class="ana01IMg"/> <div class="anaImgText"> </div></div>
                    <div class="anaText">
                          <button onclick="switch_display_mode()" class="button_press">显示模式切换</button>
                    </div>

                </div>
                <div class="boxCentterUpLeft">
                    <div class="ananBg"><img src="../static/img/ana02.png" class="ana01IMg"/> <div class="anaImgText01"> </div></div>
                    <div class="anaText">
                        <button onclick="switch_vidieo(true)" class="button_press">开启监考摄像头</button>
                    </div>

                </div>
                <div class="boxCentterUpLeft">
                    <div class="ananBg"><img src="../static/img/ana01.png" class="ana01IMg"/> <div class="anaImgText02"> </div></div>
                    <div class="anaText">
                        <button onclick="switch_vidieo(false)" class="button_press">关闭监考摄像头</button>
                    </div>

                </div>
                <div class="boxCentterRight"></div>
            </div>
            <div class="clear"></div>


            <!--地图区域-->
            <div class="boxCenterdown">
                <div class="boxCenterMap"  id="supervision_wind" >

                   <canvas id="main_canvas" class="main_canvas"></canvas>

                    <div class="mapTool01">
                     <p id="main_canvas_name" class = "main_canvas_name">img2</p>
{#                        <a href="#" class="mapToolA01 mapToolA01Active"></a>#}
{#                        <a href="#" class="mapToolA02"></a>#}
{#                        <a href="#" class="mapToolA03"></a>#}
{#                        <a href="#" class="mapToolA04"></a>#}
                    </div>
                    <div class="mapTool02">
                        <ul>
                            <li class="mapToolA05"> </li>
                            <li class="mapToolA06"> </li>
                            <li class="mapToolA07"> </li>
                            <li class="mapToolA08"> </li>
                        </ul>
                    </div>
                </div>
            </div>

        </div>
        <!--右边区域-->
        <div class="boxRight">
            <div class="boxRightTop"></div>
            <div class="clear"></div>
            <div class="boxRightCon01">
                <ul class="boxRightCon_ul">
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li02.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li02.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li03.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li03.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                    <li> 视频点位001<span><img src="../static/img/li01.png"/> </span></li>
                </ul>
            </div>
            <div class="clear"></div>
            <div class="boxRightCon02">
                <div class="boxRightcon02Top "><ul class="con02TopUL con02liAcitve"><li class="con02liAcitve">异常行为照片区</li></ul></div>
                <div class="boxRithtChangeBox">
                    <!--车辆信息-->
                    <div class="boxChangeCon" style="display: block">
                        <div class="boxChangeConFind">
                            <p><label class="boxFindLabel">异常行为类别：</label><select class="boxFindInput" id="find_unusual_type">
                                <option>所有异常行为</option>
                                <option>转头</option>
                                <option>镜头内多人</option>
                                <option>镜头内无人</option>
                            </select><label class="boxFindLabel">姓名：</label><input type="text" class="boxFindInput" id = "input_name"/></p>>
                            <p><button class="boxFindButton" onclick="search()">开始搜索</button></p>
                        </div>
                        <div class="clear"></div>

                        <ul  id="pageAll" >


                        </ul>





                    </div>
                    <!--人员详情-->
                    <div class="boxChangeCon">
                        <div class="boxChangeConFind">
                            <p><label class="boxFindLabel">人员名称：</label><input type="text" class="boxFindInput"/><label class="boxFindLabel">性别：</label><select class="boxFindInput">
                                <option>男</option>
                            </select></p>
                            <p><label class="boxFindLabel">年龄：</label><input type="text" class="boxFindInput"/> </p>
                            <p><button class="boxFindButton" id = 'search_li'>开始搜索</button></p>
                        </div>
                        <div class="clear"></div>
                        <ul id="pageAll01">
                            <li>
                                <div class="liImgLeft"><img src="../static/img/liImg.png"/> </div>
                                <div class="liConRight">
                                    <p>工号：<span>川A · 52FE2</span><span class="liconRihtButSpan"><button>定位</button></span></p>
                                    <p>姓名：<span>红色</span><span class="liconRihtButSpan"><button>详情</button></span></p>
                                    <p>职务：<span>大众</span></p>
                                </div>
                            </li>
                            <li>
                                <div class="liImgLeft"><img src="../static/img/liImg.png"/> </div>
                                <div class="liConRight">
                                    <p>工号：<span>川A · 52FE2</span><span class="liconRihtButSpan"><button>定位</button></span></p>
                                    <p>姓名：<span>红色</span><span class="liconRihtButSpan"><button>详情</button></span></p>
                                    <p>职务：<span>大众</span></p>
                                </div>
                            </li>
                            <li>
                                <div class="liImgLeft"><img src="../static/img/liImg.png"/> </div>
                                <div class="liConRight">
                                    <p>工号：<span>川A · 52FE2</span><span class="liconRihtButSpan"><button>定位</button></span></p>
                                    <p>姓名：<span>红色</span><span class="liconRihtButSpan"><button>详情</button></span></p>
                                    <p>职务：<span>大众</span></p>
                                </div>
                            </li>

                        </ul>

                    </div>
                    <!--地名地址-->
                    <div class="boxChangeCon">
                        <div class="boxChangeConFind">
                            <p><label class="boxFindLabel">地名地址：</label><input type="text" class="boxFindInput"/></p>
                            <p><button class="boxFindButton">开始搜索</button></p>
                        </div>
                        <div class="clear"></div>
                        <ul id="pageAll02">
                            <li class="addLi">
                                <div class="liConRight01">
                                    <p>地名地址：<span>天府广场001</span><span class="liconRihtButSpan01"><button>定位</button></span></p>

                                </div>
                            </li>
                            <li class="addLi">
                                <div class="liConRight01">
                                    <p>地名地址：<span>天府广场001</span><span class="liconRihtButSpan01"><button>定位</button></span></p>

                                </div>
                            </li>
                            <li class="addLi">
                                <div class="liConRight01">
                                    <p>地名地址：<span>天府广场001</span><span class="liconRihtButSpan01"><button>定位</button></span></p>

                                </div>
                            </li>
                            <li class="addLi">
                                <div class="liConRight01">
                                    <p>地名地址：<span>天府广场001</span><span class="liconRihtButSpan01"><button>定位</button></span></p>

                                </div>
                            </li>
                            <li class="addLi">
                                <div class="liConRight01">
                                    <p>地名地址：<span>天府广场001</span><span class="liconRihtButSpan01"><button>定位</button></span></p>

                                </div>
                            </li>
                            <li class="addLi">
                                <div class="liConRight01">
                                    <p>地名地址：<span>天府广场001</span><span class="liconRihtButSpan01"><button>定位</button></span></p>

                                </div>
                            </li>
                            <li class="addLi">
                                <div class="liConRight01">
                                    <p>地名地址：<span>天府广场001</span><span class="liconRihtButSpan01"><button>定位</button></span></p>

                                </div>
                            </li>
                            <li class="addLi">
                                <div class="liConRight01">
                                    <p>地名地址：<span>天府广场001</span><span class="liconRihtButSpan01"><button>定位</button></span></p>

                                </div>
                            </li>
                            <li class="addLi">
                                <div class="liConRight01">
                                    <p>地名地址：<span>天府广场001</span><span class="liconRihtButSpan01"><button>定位</button></span></p>

                                </div>
                            </li>
                            <li class="addLi">
                                <div class="liConRight01">
                                    <p>地名地址：<span>天府广场001</span><span class="liconRihtButSpan01"><button>定位</button></span></p>

                                </div>
                            </li>

                        </ul>
                        <div class="boxChangeFoot" >
                                <span class="page_box">
                                    <a id="prev03">上一页</a><span class="num"><span id="current_page03">1</span><span style="padding:3px;">/</span><span id="total03"></span></span><a id="next03">下一页</a>
                                       </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>


    </section>

</main>


<script src="../static/js/vid/jquery.js"></script>
<script src="../static/js/vid/vid_index.js"></script>

 <script>
        $.ajaxSetup({
            data:{csrfmiddlewaretoken:'{{ csrf_token }}'}
        })
 </script>
<script>

    function show_change(){


    }

    $(function(){
        $(".head-ul li a").click(function(){
            $(this).addClass("active-a").parents("li").siblings().find("a").removeClass("active-a");
            $(this).parents('li').find("ul").show();
            $(this).parents("li").sibling().find("ul").hide();

        })
        getTime();
    })
//    格式化时间
   function getTime(){
       var day=new Date();
       var year=day.getFullYear();
       var moutth=day.getMonth()+1;
       var date=day.getDate();
       var hour=day.getHours();
       var min=day.getMinutes();
       var sec=day.getSeconds();
       var str=year+'-'+moutth+'-'+date+' '+hour+":"+min+':'+sec;
       $("#time").text(str);
   }
</script>

<script>

    //显示模式切换 0为替考检测  1为yolo 检测 默认为0 替考检测
    function switch_display_mode(){
        $.ajax({
            url: '/switch_display_mode/',
            type: 'GET',
            //这个地方需要传一个名字进来，然后再后端添加一个用户，该名字用来索引该用户
            {#data: JSON.stringify({"imgData": imgData,"name":name,"check_face":false}),#}
            contentType: "json/application",

            success: function(data){
                console.log(`切换模式成功${data}`)
            }

        })
    }


    //用来存异常行为路径的列表，用于判断服务器端的图片是否重复
    list_data = []


    function drew_canvas(iamgeID){
        //改这里
        var image = document.getElementById(iamgeID);
        canvas = document.getElementById("main_canvas");
        canvas.width=1500;		// 注意：没有单位
	    canvas.height=2000;	// 注意：没有单位
        ctx = canvas.getContext('2d');

        ctx.drawImage(image, 0, 0, 1500, 1500);
    }

    //先将画布渲染上去
    drew_canvas("img2")

    //浏览器刷新时间
    setTimeout(function(){
    window.location.reload();
    },300000);


    function release(){
        var image = document.getElementById("supervision_wind");
        console.log("释放")
        image.style.backgroundImage = null
        CollectGarbage()
        {#$("#supervision_wind").remove();#}
    }
        // 判断浏览器是否支持WebSocket，目前应该所有的浏览器都支持了.....
    if ('WebSocket' in window) {
        console.log('你的浏览器支持 WebSocket')
    }


    // 创建一个WebSocket对象：sk，并且建立与服务端的连接（服务端程序要跑着哦）
    {#var sk =undefined#}
    //这是canvas主屏显示的id
    var imageID = "img2"
    function switch_vidieo(tag) {

        //渲染画布
        var i = window.setInterval(function () {
            drew_canvas(imageID)

        }, 50)

        //关闭套接字
        if (tag == false) {
            //获取所有的窗口 把他置为原始静态窗口
            var image = document.getElementById(imageID);
            image.src = "../static/ynu.PNG"

            sk.close()
        } else if (tag == true) { //开启套接字
            sk = new WebSocket('ws://222.19.236.133:8000/websocket/');

            // 向服务端发送消息
            sk.onopen = function () {
                console.log('websocket connection successful...');
                var l = ['1', '2', '3'];
                sk.send(JSON.stringify(l));
            };
            // 接收服务端的消息，主要的业务逻辑也在这里完成
            //获取画布上的图片
            sk.onmessage = function (msg) {
                // 业务逻辑
                data = msg.data
                data = JSON.parse(data)
                if (data["socket_type"] == 0) {//0是监控视频数据
                    var image = document.getElementById("img2");
                    image_src = `${data["img_DataURL"]}`
                    image.src = image_src

                    //将后端传过来的当前用户的名字渲染上去 先渲染到name2上
                    {#$(`#name2`).html(`${data['user_name']}`)#}
                    {#console.log(data)#}

                }

                else if (data["socket_type"] == 1) {//1是图片日志
                    console.log("更新图片和日志")
                    get_unusual_image()
                }


                // 由于服务端主动断开连接，这里也断开WebSocket连接
                if (sk.readyState == WebSocket.CLOSED) sk.close();

            };
            // 完事就关闭WebSocket连接
            sk.onclose = function (msg) {
                console.log('websocket connection close...');
                sk.close()
            };
            // 当WebSocket连接创建成功后，我们就可以向服务端发送数据了
            if (sk.readyState == WebSocket.OPEN) sk.onopen();

        }


    }



    //每隔几秒向服务器发送通信
    //setInterval(function (){
      //  sk.send(1231)
        //console.log(1231)},3000)

    html = `
                                <div class="liImgLeft"><img src="../static/unusal_action/20220103130050.jpg"> </div>
                                <div class="liConRight">
                                    <p>姓名：<span>王鑫超</span><span class="liconRihtButSpan"><button>定位</button></span></p>
                                    <p>异常行为：<span>偏头</span><span class="liconRihtButSpan"><button>详情</button></span></p>
                                    <p>车辆品牌：<span>1大众</span></p>
                                </div>
`
    function addli(){
        new_li = document.createElement('li')
        new_li.innerHTML = html
        document.getElementById("pageAll").appendChild(new_li)

    }

    function get_unusual_image() {
        $.ajax({
            url: '/photo_list/',
            type: "GET",

            success: function (data, status) {
                data = JSON.parse(data)
                photo_paths = data['photo_paths']
                ab_path = data['ab_path']
                for (i in photo_paths) {
                    photo_path = ab_path + '\\' + photo_paths[i]
                    //如果该图片是新来的
                    if (list_data.includes(photo_paths[i]) == false) {

                        console.log(photo_paths[i])
                        //正则表达式 根据图片的命名规则获得信息字段
                        information_list = photo_paths[i].split("_")
                        //年月日 YMD
                        photo_time_YMD = information_list[0].split(" ")[0].split("-")
                        //时分秒 HMS
                        photo_time_HMS = information_list[0].split(" ")[1].split("-")
                        photo_time_HMS[0] =  parseInt(photo_time_HMS[0]) + 8
                        photo_name = information_list[1]
                        photo_action = information_list[2].split(".")[0]
                        //加入
                        list_data.push(photo_paths[i])
                        html_photo_li = `
                                <div class="liImgLeft"><img src="../static/unusal_action/${photo_paths[i]}"> </div>
                                <div class="liConRight">
                                    <p>姓名：<span class="name">${photo_name}</span><span class="liconRihtButSpan"><button>定位</button></span></p>
                                    <p>异常行为：<span class="action">${photo_action}</span><span class="liconRihtButSpan"><button>详情</button></span></p>
                                    <p>时间：<span class="date">${photo_time_YMD[0]}年${photo_time_YMD[1]}月${photo_time_YMD[2]}日 ${photo_time_HMS[0]}时${photo_time_HMS[1]}分${photo_time_HMS[2]}秒</span></p>
                                </div>
`
                        html_log_li = `
                                <p>异常行为：${photo_action}<span class="alamULspan">${photo_time_YMD[0]}年${photo_time_YMD[1]}月${photo_time_YMD[2]}日/${photo_time_HMS[0]}时${photo_time_HMS[1]}分${photo_time_HMS[2]}秒</span></p>
                                <p>异常描述：${photo_name}同学镜头内出现${photo_action}行为异常</p>
                    `

                        new_photo_li = document.createElement('li')
                        new_photo_li.innerHTML = html_photo_li
                        photo_node = document.getElementById("pageAll")
                        photo_node.appendChild(new_photo_li).className = 'unusual_image'

                        new_log_li = document.createElement('li')
                        new_log_li.innerHTML = html_log_li
                        log_node = document.getElementById("log_all")
                        log_node.appendChild(new_log_li).className = 'unusual_log'


                    }


                }
            }

        })
    }

    //一开始便去获得异常图片和信息
    get_unusual_image()

    {#$("li span:contains(王鑫超)").hide()#}

    //搜索异常图片
    function search() {
        search_name = $("#input_name").val()
        search_action = $("#find_unusual_type").val()
        if (search_name != ""&&search_action != "所有异常行为") {
            $("li.unusual_image").filter(`:contains(${search_action})`).not(`:contains(${search_name})`).hide()
            $("li.unusual_image").filter(`:contains(${search_action})`).filter(`:contains(${search_name})`).show()
        } else if (search_name != ""&&search_action == "所有异常行为"){
             $("li.unusual_image").not(`:contains(${search_name})`).hide()
             $("li.unusual_image").filter(`:contains(${search_name})`).show()
        }else if (search_name == ""&&search_action != "所有异常行为"){
             $("li.unusual_image").not(`:contains(${search_action})`).hide()
             $("li.unusual_image").filter(`:contains(${search_action})`).show()
        }else {
            $("li.unusual_image").show()
        }


    }


    Node.prototype.prependChild = function (newNode){
                 this.insertBefore(newNode,this.firstChild);
             }

    document.addEventListener('keydown', function (e) {
        if (e.keyCode == 13) {
            switch_vidieo(true)
        }
    })

    function click_video(dom){
        imageID = dom.id


        img_name_id = `name${imageID[3]}`
        {#console.log(img_name)#}

        img_name=$(`#${img_name_id}`).text()
        //展示
        $('#main_canvas_name').html(img_name)
    }


</script>

</body>
</html>
